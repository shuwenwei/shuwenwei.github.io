<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Spring Aop - sww的博客</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="sww" /><meta name="description" content="spring-aop源码阅读" /><meta name="keywords" content="Hugo, theme, even" />






<meta name="generator" content="Hugo 0.74.3 with theme even" />

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css">

<link rel="canonical" href="https://shuwenwei.github.io/post/spring-aop/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<link href="/sass/main.min.edf09ea6f1f56c1644868fb54b66ca73bc1017248e0c3945cefe648485609270.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Spring Aop" />
<meta property="og:description" content="spring-aop源码阅读" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://shuwenwei.github.io/post/spring-aop/" />
<meta property="article:published_time" content="2020-08-28T14:55:41+08:00" />
<meta property="article:modified_time" content="2020-08-28T14:55:41+08:00" />
<meta itemprop="name" content="Spring Aop">
<meta itemprop="description" content="spring-aop源码阅读">
<meta itemprop="datePublished" content="2020-08-28T14:55:41+08:00" />
<meta itemprop="dateModified" content="2020-08-28T14:55:41+08:00" />
<meta itemprop="wordCount" content="5263">



<meta itemprop="keywords" content="spring,spring-aop,java," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Spring Aop"/>
<meta name="twitter:description" content="spring-aop源码阅读"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Even</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/content/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Even</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/content/about/">About</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Spring Aop</h1>

      <div class="post-meta">
        <span class="post-time"> 2020-08-28 </span>
        <div class="post-category">
            <a href="/categories/java/"> java </a>
            </div>
          <span class="more-meta"> 约 5263 字 </span>
          <span class="more-meta"> 预计阅读 11 分钟 </span>
        <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次阅读 </span>
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#加载beandefinition">加载BeanDefinition</a></li>
        <li><a href="#生成代理对象">生成代理对象</a>
          <ul>
            <li><a href="#jdkdynamicaopproxy">JdkDynamicAopProxy</a></li>
            <li><a href="#cglibaopproxy">CglibAopProxy</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="加载beandefinition">加载BeanDefinition</h2>
<p>加载BeanDefinition时，在DefaultBeanDefinitionDocumentReader的parseBeanDefinition方法中</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">parseBeanDefinitions</span><span class="o">(</span><span class="n">Element</span> <span class="n">root</span><span class="o">,</span> <span class="n">BeanDefinitionParserDelegate</span> <span class="n">delegate</span><span class="o">)</span> <span class="o">{</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">delegate</span><span class="o">.</span><span class="na">isDefaultNamespace</span><span class="o">(</span><span class="n">root</span><span class="o">))</span> <span class="o">{</span>
      <span class="n">NodeList</span> <span class="n">nl</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="na">getChildNodes</span><span class="o">();</span>
      <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nl</span><span class="o">.</span><span class="na">getLength</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
         <span class="n">Node</span> <span class="n">node</span> <span class="o">=</span> <span class="n">nl</span><span class="o">.</span><span class="na">item</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
         <span class="k">if</span> <span class="o">(</span><span class="n">node</span> <span class="k">instanceof</span> <span class="n">Element</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Element</span> <span class="n">ele</span> <span class="o">=</span> <span class="o">(</span><span class="n">Element</span><span class="o">)</span> <span class="n">node</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">delegate</span><span class="o">.</span><span class="na">isDefaultNamespace</span><span class="o">(</span><span class="n">ele</span><span class="o">))</span> <span class="o">{</span>
               <span class="n">parseDefaultElement</span><span class="o">(</span><span class="n">ele</span><span class="o">,</span> <span class="n">delegate</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">else</span> <span class="o">{</span>
                <span class="c1">//加载非默认的element
</span><span class="c1"></span>               <span class="n">delegate</span><span class="o">.</span><span class="na">parseCustomElement</span><span class="o">(</span><span class="n">ele</span><span class="o">);</span>
            <span class="o">}</span>
         <span class="o">}</span>
      <span class="o">}</span>
   <span class="o">}</span>
   <span class="k">else</span> <span class="o">{</span>
      <span class="n">delegate</span><span class="o">.</span><span class="na">parseCustomElement</span><span class="o">(</span><span class="n">root</span><span class="o">);</span>
   <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">BeanDefinition</span> <span class="nf">parseCustomElement</span><span class="o">(</span><span class="n">Element</span> <span class="n">ele</span><span class="o">)</span> <span class="o">{</span>
   <span class="k">return</span> <span class="n">parseCustomElement</span><span class="o">(</span><span class="n">ele</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">BeanDefinition</span> <span class="nf">parseCustomElement</span><span class="o">(</span><span class="n">Element</span> <span class="n">ele</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="n">BeanDefinition</span> <span class="n">containingBd</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//获取这个element的namespaceUri
</span><span class="c1"></span>   <span class="n">String</span> <span class="n">namespaceUri</span> <span class="o">=</span> <span class="n">getNamespaceURI</span><span class="o">(</span><span class="n">ele</span><span class="o">);</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">namespaceUri</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
   <span class="o">}</span>
    <span class="c1">//获取对应的namespaceHandlerResolver，然后由resolver处理namespaceUri返回合适的namespaceHandler
</span><span class="c1"></span>   <span class="n">NamespaceHandler</span> <span class="n">handler</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">readerContext</span><span class="o">.</span><span class="na">getNamespaceHandlerResolver</span><span class="o">().</span><span class="na">resolve</span><span class="o">(</span><span class="n">namespaceUri</span><span class="o">);</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">handler</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">error</span><span class="o">(</span><span class="s">&#34;Unable to locate Spring NamespaceHandler for XML schema namespace [&#34;</span> <span class="o">+</span> <span class="n">namespaceUri</span> <span class="o">+</span> <span class="s">&#34;]&#34;</span><span class="o">,</span> <span class="n">ele</span><span class="o">);</span>
      <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
   <span class="o">}</span>
    <span class="c1">//解析element
</span><span class="c1"></span>   <span class="k">return</span> <span class="n">handler</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">ele</span><span class="o">,</span> <span class="k">new</span> <span class="n">ParserContext</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">readerContext</span><span class="o">,</span> <span class="k">this</span><span class="o">,</span> <span class="n">containingBd</span><span class="o">));</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">NamespaceHandler</span> <span class="nf">resolve</span><span class="o">(</span><span class="n">String</span> <span class="n">namespaceUri</span><span class="o">);</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">NamespaceHandler</span> <span class="nf">resolve</span><span class="o">(</span><span class="n">String</span> <span class="n">namespaceUri</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//获取namespaceUri对namespaceHandler或类名的映射
</span><span class="c1"></span>   <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">handlerMappings</span> <span class="o">=</span> <span class="n">getHandlerMappings</span><span class="o">();</span>
    <span class="c1">//取出当前namespaceUri对应的namespaceHandler或这个namespaceHandler类的全名
</span><span class="c1"></span>    <span class="c1">//如果已经加载过一次就会是namespaceHandler对象
</span><span class="c1"></span>   <span class="n">Object</span> <span class="n">handlerOrClassName</span> <span class="o">=</span> <span class="n">handlerMappings</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">namespaceUri</span><span class="o">);</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">handlerOrClassName</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
   <span class="o">}</span>
    <span class="c1">//如果是namespaceHandler的实例
</span><span class="c1"></span>   <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">handlerOrClassName</span> <span class="k">instanceof</span> <span class="n">NamespaceHandler</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="o">(</span><span class="n">NamespaceHandler</span><span class="o">)</span> <span class="n">handlerOrClassName</span><span class="o">;</span>
   <span class="o">}</span>
   <span class="k">else</span> <span class="o">{</span>
       <span class="c1">//如果是类名
</span><span class="c1"></span>      <span class="n">String</span> <span class="n">className</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">handlerOrClassName</span><span class="o">;</span>
      <span class="k">try</span> <span class="o">{</span>
          <span class="c1">//反射加载类，aop这里对应的类名是org.springframework.aop.config.AopNamespaceHandler
</span><span class="c1"></span>         <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">handlerClass</span> <span class="o">=</span> <span class="n">ClassUtils</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="n">className</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">classLoader</span><span class="o">);</span>
         <span class="k">if</span> <span class="o">(!</span><span class="n">NamespaceHandler</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">handlerClass</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">FatalBeanException</span><span class="o">(</span><span class="s">&#34;Class [&#34;</span> <span class="o">+</span> <span class="n">className</span> <span class="o">+</span> <span class="s">&#34;] for namespace [&#34;</span> <span class="o">+</span> <span class="n">namespaceUri</span> <span class="o">+</span>
                  <span class="s">&#34;] does not implement the [&#34;</span> <span class="o">+</span> <span class="n">NamespaceHandler</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;] interface&#34;</span><span class="o">);</span>
         <span class="o">}</span>
          <span class="c1">//实例化
</span><span class="c1"></span>         <span class="n">NamespaceHandler</span> <span class="n">namespaceHandler</span> <span class="o">=</span> <span class="o">(</span><span class="n">NamespaceHandler</span><span class="o">)</span> <span class="n">BeanUtils</span><span class="o">.</span><span class="na">instantiateClass</span><span class="o">(</span><span class="n">handlerClass</span><span class="o">);</span>
          <span class="c1">//调用namespaceHandler的初始化方法，这里对应AopNamespaceHandler的init方法
</span><span class="c1"></span>         <span class="n">namespaceHandler</span><span class="o">.</span><span class="na">init</span><span class="o">();</span>
          <span class="c1">//在已有的映射中添加
</span><span class="c1"></span>         <span class="n">handlerMappings</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">namespaceUri</span><span class="o">,</span> <span class="n">namespaceHandler</span><span class="o">);</span>
         <span class="k">return</span> <span class="n">namespaceHandler</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="k">catch</span> <span class="o">(</span><span class="n">ClassNotFoundException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">throw</span> <span class="k">new</span> <span class="n">FatalBeanException</span><span class="o">(</span><span class="s">&#34;Could not find NamespaceHandler class [&#34;</span> <span class="o">+</span> <span class="n">className</span> <span class="o">+</span>
               <span class="s">&#34;] for namespace [&#34;</span> <span class="o">+</span> <span class="n">namespaceUri</span> <span class="o">+</span> <span class="s">&#34;]&#34;</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">catch</span> <span class="o">(</span><span class="n">LinkageError</span> <span class="n">err</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">throw</span> <span class="k">new</span> <span class="n">FatalBeanException</span><span class="o">(</span><span class="s">&#34;Unresolvable class definition for NamespaceHandler class [&#34;</span> <span class="o">+</span>
               <span class="n">className</span> <span class="o">+</span> <span class="s">&#34;] for namespace [&#34;</span> <span class="o">+</span> <span class="n">namespaceUri</span> <span class="o">+</span> <span class="s">&#34;]&#34;</span><span class="o">,</span> <span class="n">err</span><span class="o">);</span>
      <span class="o">}</span>
   <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>getHandlerMappings方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="nf">getHandlerMappings</span><span class="o">()</span> <span class="o">{</span>
   <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">handlerMappings</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">handlerMappings</span><span class="o">;</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">handlerMappings</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
         <span class="n">handlerMappings</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">handlerMappings</span><span class="o">;</span>
          <span class="c1">//还不存在映射就去加载
</span><span class="c1"></span>         <span class="k">if</span> <span class="o">(</span><span class="n">handlerMappings</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isTraceEnabled</span><span class="o">())</span> <span class="o">{</span>
               <span class="n">logger</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">&#34;Loading NamespaceHandler mappings from [&#34;</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">handlerMappingsLocation</span> <span class="o">+</span> <span class="s">&#34;]&#34;</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="c1">//读取资源文件，在构造函数中赋值了handlerMappingsLocation为META-INF/spring.handlers
</span><span class="c1"></span>                <span class="c1">//可以在spring-aop的jar包内找到spring.handlers
</span><span class="c1"></span>                <span class="c1">//内容为http\://www.springframework.org/schema/aop=org.springframework.aop.config.AopNamespaceHandler
</span><span class="c1"></span>
               <span class="n">Properties</span> <span class="n">mappings</span> <span class="o">=</span>
                     <span class="n">PropertiesLoaderUtils</span><span class="o">.</span><span class="na">loadAllProperties</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">handlerMappingsLocation</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">classLoader</span><span class="o">);</span>
               <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isTraceEnabled</span><span class="o">())</span> <span class="o">{</span>
                  <span class="n">logger</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">&#34;Loaded NamespaceHandler mappings: &#34;</span> <span class="o">+</span> <span class="n">mappings</span><span class="o">);</span>
               <span class="o">}</span>
               <span class="n">handlerMappings</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;(</span><span class="n">mappings</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
                <span class="c1">//将Properties合并到map中
</span><span class="c1"></span>               <span class="n">CollectionUtils</span><span class="o">.</span><span class="na">mergePropertiesIntoMap</span><span class="o">(</span><span class="n">mappings</span><span class="o">,</span> <span class="n">handlerMappings</span><span class="o">);</span>
               <span class="k">this</span><span class="o">.</span><span class="na">handlerMappings</span> <span class="o">=</span> <span class="n">handlerMappings</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
               <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span>
                     <span class="s">&#34;Unable to load NamespaceHandler mappings from location [&#34;</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">handlerMappingsLocation</span> <span class="o">+</span> <span class="s">&#34;]&#34;</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
            <span class="o">}</span>
         <span class="o">}</span>
      <span class="o">}</span>
   <span class="o">}</span>
   <span class="k">return</span> <span class="n">handlerMappings</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>回到resolve方法，查看namespaceHandler.init();</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kt">void</span> <span class="nf">init</span><span class="o">();</span>
</code></pre></td></tr></table>
</div>
</div><p>找到对应的AopNamespaceHandler类</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AopNamespaceHandler</span> <span class="kd">extends</span> <span class="n">NamespaceHandlerSupport</span> <span class="o">{</span>

   <span class="cm">/**
</span><span class="cm">    * Register the {@link BeanDefinitionParser BeanDefinitionParsers} for the
</span><span class="cm">    * &#39;{@code config}&#39;, &#39;{@code spring-configured}&#39;, &#39;{@code aspectj-autoproxy}&#39;
</span><span class="cm">    * and &#39;{@code scoped-proxy}&#39; tags.
</span><span class="cm">    */</span>
   <span class="nd">@Override</span>
    <span class="c1">//添加了一些parser
</span><span class="c1"></span>   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">()</span> <span class="o">{</span>
      <span class="c1">// In 2.0 XSD as well as in 2.5+ XSDs
</span><span class="c1"></span>      <span class="n">registerBeanDefinitionParser</span><span class="o">(</span><span class="s">&#34;config&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">ConfigBeanDefinitionParser</span><span class="o">());</span>
      <span class="n">registerBeanDefinitionParser</span><span class="o">(</span><span class="s">&#34;aspectj-autoproxy&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">AspectJAutoProxyBeanDefinitionParser</span><span class="o">());</span>
      <span class="n">registerBeanDefinitionDecorator</span><span class="o">(</span><span class="s">&#34;scoped-proxy&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">ScopedProxyBeanDefinitionDecorator</span><span class="o">());</span>

      <span class="c1">// Only in 2.0 XSD: moved to context namespace in 2.5+
</span><span class="c1"></span>      <span class="n">registerBeanDefinitionParser</span><span class="o">(</span><span class="s">&#34;spring-configured&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">SpringConfiguredBeanDefinitionParser</span><span class="o">());</span>
   <span class="o">}</span>

<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">BeanDefinitionParser</span><span class="o">&gt;</span> <span class="n">parsers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>

<span class="kd">protected</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">registerBeanDefinitionParser</span><span class="o">(</span><span class="n">String</span> <span class="n">elementName</span><span class="o">,</span> <span class="n">BeanDefinitionParser</span> <span class="n">parser</span><span class="o">)</span> <span class="o">{</span>
   <span class="k">this</span><span class="o">.</span><span class="na">parsers</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">elementName</span><span class="o">,</span> <span class="n">parser</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>回到之前的BeanDefinitionParserDelegate的parseCustomElement方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">BeanDefinition</span> <span class="nf">parseCustomElement</span><span class="o">(</span><span class="n">Element</span> <span class="n">ele</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="n">BeanDefinition</span> <span class="n">containingBd</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//获取这个element的namespaceUri
</span><span class="c1"></span>   <span class="n">String</span> <span class="n">namespaceUri</span> <span class="o">=</span> <span class="n">getNamespaceURI</span><span class="o">(</span><span class="n">ele</span><span class="o">);</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">namespaceUri</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
   <span class="o">}</span>
    <span class="c1">//获取对应的namespaceHandlerResolver，然后由resolver处理namespaceUri返回合适的namespaceHandler
</span><span class="c1"></span>   <span class="n">NamespaceHandler</span> <span class="n">handler</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">readerContext</span><span class="o">.</span><span class="na">getNamespaceHandlerResolver</span><span class="o">().</span><span class="na">resolve</span><span class="o">(</span><span class="n">namespaceUri</span><span class="o">);</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">handler</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">error</span><span class="o">(</span><span class="s">&#34;Unable to locate Spring NamespaceHandler for XML schema namespace [&#34;</span> <span class="o">+</span> <span class="n">namespaceUri</span> <span class="o">+</span> <span class="s">&#34;]&#34;</span><span class="o">,</span> <span class="n">ele</span><span class="o">);</span>
      <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
   <span class="o">}</span>
    <span class="c1">//解析element
</span><span class="c1"></span>   <span class="k">return</span> <span class="n">handler</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">ele</span><span class="o">,</span> <span class="k">new</span> <span class="n">ParserContext</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">readerContext</span><span class="o">,</span> <span class="k">this</span><span class="o">,</span> <span class="n">containingBd</span><span class="o">));</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">BeanDefinition</span> <span class="nf">parse</span><span class="o">(</span><span class="n">Element</span> <span class="n">element</span><span class="o">,</span> <span class="n">ParserContext</span> <span class="n">parserContext</span><span class="o">);</span>
</code></pre></td></tr></table>
</div>
</div><p>这里AopNamespaceHandler是NamespaceHandlerSupport下的，找到NamespaceHandlerSupport的parse实现方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">BeanDefinition</span> <span class="nf">parse</span><span class="o">(</span><span class="n">Element</span> <span class="n">element</span><span class="o">,</span> <span class="n">ParserContext</span> <span class="n">parserContext</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//查找parser
</span><span class="c1"></span>   <span class="n">BeanDefinitionParser</span> <span class="n">parser</span> <span class="o">=</span> <span class="n">findParserForElement</span><span class="o">(</span><span class="n">element</span><span class="o">,</span> <span class="n">parserContext</span><span class="o">);</span>
   <span class="k">return</span> <span class="o">(</span><span class="n">parser</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">parser</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">element</span><span class="o">,</span> <span class="n">parserContext</span><span class="o">)</span> <span class="o">:</span> <span class="kc">null</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="n">BeanDefinitionParser</span> <span class="nf">findParserForElement</span><span class="o">(</span><span class="n">Element</span> <span class="n">element</span><span class="o">,</span> <span class="n">ParserContext</span> <span class="n">parserContext</span><span class="o">)</span> <span class="o">{</span>
   <span class="n">String</span> <span class="n">localName</span> <span class="o">=</span> <span class="n">parserContext</span><span class="o">.</span><span class="na">getDelegate</span><span class="o">().</span><span class="na">getLocalName</span><span class="o">(</span><span class="n">element</span><span class="o">);</span>
    <span class="c1">//从之前提到的parsers这个map中找到对应的parser
</span><span class="c1"></span>   <span class="n">BeanDefinitionParser</span> <span class="n">parser</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">parsers</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">localName</span><span class="o">);</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">parser</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">parserContext</span><span class="o">.</span><span class="na">getReaderContext</span><span class="o">().</span><span class="na">fatal</span><span class="o">(</span>
            <span class="s">&#34;Cannot locate BeanDefinitionParser for element [&#34;</span> <span class="o">+</span> <span class="n">localName</span> <span class="o">+</span> <span class="s">&#34;]&#34;</span><span class="o">,</span> <span class="n">element</span><span class="o">);</span>
   <span class="o">}</span>
   <span class="k">return</span> <span class="n">parser</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>然后就可以解析非默认的element了，查看一下ConfigBeanDefinitionParser的parse方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">BeanDefinition</span> <span class="nf">parse</span><span class="o">(</span><span class="n">Element</span> <span class="n">element</span><span class="o">,</span> <span class="n">ParserContext</span> <span class="n">parserContext</span><span class="o">)</span> <span class="o">{</span>
   <span class="n">CompositeComponentDefinition</span> <span class="n">compositeDef</span> <span class="o">=</span>
         <span class="k">new</span> <span class="n">CompositeComponentDefinition</span><span class="o">(</span><span class="n">element</span><span class="o">.</span><span class="na">getTagName</span><span class="o">(),</span> <span class="n">parserContext</span><span class="o">.</span><span class="na">extractSource</span><span class="o">(</span><span class="n">element</span><span class="o">));</span>
   <span class="n">parserContext</span><span class="o">.</span><span class="na">pushContainingComponent</span><span class="o">(</span><span class="n">compositeDef</span><span class="o">);</span>

   <span class="n">configureAutoProxyCreator</span><span class="o">(</span><span class="n">parserContext</span><span class="o">,</span> <span class="n">element</span><span class="o">);</span>

   <span class="n">List</span><span class="o">&lt;</span><span class="n">Element</span><span class="o">&gt;</span> <span class="n">childElts</span> <span class="o">=</span> <span class="n">DomUtils</span><span class="o">.</span><span class="na">getChildElements</span><span class="o">(</span><span class="n">element</span><span class="o">);</span>
   <span class="k">for</span> <span class="o">(</span><span class="n">Element</span> <span class="n">elt</span><span class="o">:</span> <span class="n">childElts</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">String</span> <span class="n">localName</span> <span class="o">=</span> <span class="n">parserContext</span><span class="o">.</span><span class="na">getDelegate</span><span class="o">().</span><span class="na">getLocalName</span><span class="o">(</span><span class="n">elt</span><span class="o">);</span>
       <span class="c1">//pointcut
</span><span class="c1"></span>      <span class="k">if</span> <span class="o">(</span><span class="n">POINTCUT</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">localName</span><span class="o">))</span> <span class="o">{</span>
         <span class="n">parsePointcut</span><span class="o">(</span><span class="n">elt</span><span class="o">,</span> <span class="n">parserContext</span><span class="o">);</span>
      <span class="o">}</span>
       <span class="c1">//advisor
</span><span class="c1"></span>      <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">ADVISOR</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">localName</span><span class="o">))</span> <span class="o">{</span>
         <span class="n">parseAdvisor</span><span class="o">(</span><span class="n">elt</span><span class="o">,</span> <span class="n">parserContext</span><span class="o">);</span>
      <span class="o">}</span>
       <span class="c1">//aspect
</span><span class="c1"></span>      <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">ASPECT</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">localName</span><span class="o">))</span> <span class="o">{</span>
         <span class="n">parseAspect</span><span class="o">(</span><span class="n">elt</span><span class="o">,</span> <span class="n">parserContext</span><span class="o">);</span>
      <span class="o">}</span>
   <span class="o">}</span>

   <span class="n">parserContext</span><span class="o">.</span><span class="na">popAndRegisterContainingComponent</span><span class="o">();</span>
   <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="生成代理对象">生成代理对象</h2>
<p>生成代理的时机是在bean初始化后，先在doCreateBean方法中找到initializeBean方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span><span class="lnt">97
</span><span class="lnt">98
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">protected</span> <span class="n">Object</span> <span class="nf">doCreateBean</span><span class="o">(</span><span class="n">String</span> <span class="n">beanName</span><span class="o">,</span> <span class="n">RootBeanDefinition</span> <span class="n">mbd</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">BeanCreationException</span> <span class="o">{</span>

   <span class="c1">// Instantiate the bean.
</span><span class="c1"></span>   <span class="n">BeanWrapper</span> <span class="n">instanceWrapper</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">isSingleton</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">instanceWrapper</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">factoryBeanInstanceCache</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
   <span class="o">}</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">instanceWrapper</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">instanceWrapper</span> <span class="o">=</span> <span class="n">createBeanInstance</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
   <span class="o">}</span>
   <span class="n">Object</span> <span class="n">bean</span> <span class="o">=</span> <span class="n">instanceWrapper</span><span class="o">.</span><span class="na">getWrappedInstance</span><span class="o">();</span>
   <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">beanType</span> <span class="o">=</span> <span class="n">instanceWrapper</span><span class="o">.</span><span class="na">getWrappedClass</span><span class="o">();</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">beanType</span> <span class="o">!=</span> <span class="n">NullBean</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">mbd</span><span class="o">.</span><span class="na">resolvedTargetType</span> <span class="o">=</span> <span class="n">beanType</span><span class="o">;</span>
   <span class="o">}</span>

   <span class="c1">// Allow post-processors to modify the merged bean definition.
</span><span class="c1"></span>   <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">postProcessingLock</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">mbd</span><span class="o">.</span><span class="na">postProcessed</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">try</span> <span class="o">{</span>
            <span class="n">applyMergedBeanDefinitionPostProcessors</span><span class="o">(</span><span class="n">mbd</span><span class="o">,</span> <span class="n">beanType</span><span class="o">,</span> <span class="n">beanName</span><span class="o">);</span>
         <span class="o">}</span>
         <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">BeanCreationException</span><span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">getResourceDescription</span><span class="o">(),</span> <span class="n">beanName</span><span class="o">,</span>
                  <span class="s">&#34;Post-processing of merged bean definition failed&#34;</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
         <span class="o">}</span>
         <span class="n">mbd</span><span class="o">.</span><span class="na">postProcessed</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
      <span class="o">}</span>
   <span class="o">}</span>

   <span class="c1">// Eagerly cache singletons to be able to resolve circular references
</span><span class="c1"></span>   <span class="c1">// even when triggered by lifecycle interfaces like BeanFactoryAware.
</span><span class="c1"></span>   <span class="kt">boolean</span> <span class="n">earlySingletonExposure</span> <span class="o">=</span> <span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">isSingleton</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="o">.</span><span class="na">allowCircularReferences</span> <span class="o">&amp;&amp;</span>
         <span class="n">isSingletonCurrentlyInCreation</span><span class="o">(</span><span class="n">beanName</span><span class="o">));</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">earlySingletonExposure</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isTraceEnabled</span><span class="o">())</span> <span class="o">{</span>
         <span class="n">logger</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">&#34;Eagerly caching bean &#39;&#34;</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span>
               <span class="s">&#34;&#39; to allow for resolving potential circular references&#34;</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="n">addSingletonFactory</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="n">getEarlyBeanReference</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">,</span> <span class="n">bean</span><span class="o">));</span>
   <span class="o">}</span>

   <span class="c1">// Initialize the bean instance.
</span><span class="c1"></span>   <span class="n">Object</span> <span class="n">exposedObject</span> <span class="o">=</span> <span class="n">bean</span><span class="o">;</span>
   <span class="k">try</span> <span class="o">{</span>
      <span class="n">populateBean</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">,</span> <span class="n">instanceWrapper</span><span class="o">);</span>
       <span class="c1">// 初始化bean方法
</span><span class="c1"></span>      <span class="n">exposedObject</span> <span class="o">=</span> <span class="n">initializeBean</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">exposedObject</span><span class="o">,</span> <span class="n">mbd</span><span class="o">);</span>
   <span class="o">}</span>
   <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">ex</span> <span class="k">instanceof</span> <span class="n">BeanCreationException</span> <span class="o">&amp;&amp;</span> <span class="n">beanName</span><span class="o">.</span><span class="na">equals</span><span class="o">(((</span><span class="n">BeanCreationException</span><span class="o">)</span> <span class="n">ex</span><span class="o">).</span><span class="na">getBeanName</span><span class="o">()))</span> <span class="o">{</span>
         <span class="k">throw</span> <span class="o">(</span><span class="n">BeanCreationException</span><span class="o">)</span> <span class="n">ex</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="k">else</span> <span class="o">{</span>
         <span class="k">throw</span> <span class="k">new</span> <span class="n">BeanCreationException</span><span class="o">(</span>
               <span class="n">mbd</span><span class="o">.</span><span class="na">getResourceDescription</span><span class="o">(),</span> <span class="n">beanName</span><span class="o">,</span> <span class="s">&#34;Initialization of bean failed&#34;</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
      <span class="o">}</span>
   <span class="o">}</span>

   <span class="k">if</span> <span class="o">(</span><span class="n">earlySingletonExposure</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">Object</span> <span class="n">earlySingletonReference</span> <span class="o">=</span> <span class="n">getSingleton</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">earlySingletonReference</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">if</span> <span class="o">(</span><span class="n">exposedObject</span> <span class="o">==</span> <span class="n">bean</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">exposedObject</span> <span class="o">=</span> <span class="n">earlySingletonReference</span><span class="o">;</span>
         <span class="o">}</span>
         <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="k">this</span><span class="o">.</span><span class="na">allowRawInjectionDespiteWrapping</span> <span class="o">&amp;&amp;</span> <span class="n">hasDependentBean</span><span class="o">(</span><span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">String</span><span class="o">[]</span> <span class="n">dependentBeans</span> <span class="o">=</span> <span class="n">getDependentBeans</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
            <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">actualDependentBeans</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedHashSet</span><span class="o">&lt;&gt;(</span><span class="n">dependentBeans</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
            <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">dependentBean</span> <span class="o">:</span> <span class="n">dependentBeans</span><span class="o">)</span> <span class="o">{</span>
               <span class="k">if</span> <span class="o">(!</span><span class="n">removeSingletonIfCreatedForTypeCheckOnly</span><span class="o">(</span><span class="n">dependentBean</span><span class="o">))</span> <span class="o">{</span>
                  <span class="n">actualDependentBeans</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">dependentBean</span><span class="o">);</span>
               <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">actualDependentBeans</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
               <span class="k">throw</span> <span class="k">new</span> <span class="n">BeanCurrentlyInCreationException</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span>
                     <span class="s">&#34;Bean with name &#39;&#34;</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span> <span class="s">&#34;&#39; has been injected into other beans [&#34;</span> <span class="o">+</span>
                     <span class="n">StringUtils</span><span class="o">.</span><span class="na">collectionToCommaDelimitedString</span><span class="o">(</span><span class="n">actualDependentBeans</span><span class="o">)</span> <span class="o">+</span>
                     <span class="s">&#34;] in its raw version as part of a circular reference, but has eventually been &#34;</span> <span class="o">+</span>
                     <span class="s">&#34;wrapped. This means that said other beans do not use the final version of the &#34;</span> <span class="o">+</span>
                     <span class="s">&#34;bean. This is often the result of over-eager type matching - consider using &#34;</span> <span class="o">+</span>
                     <span class="s">&#34;&#39;getBeanNamesForType&#39; with the &#39;allowEagerInit&#39; flag turned off, for example.&#34;</span><span class="o">);</span>
            <span class="o">}</span>
         <span class="o">}</span>
      <span class="o">}</span>
   <span class="o">}</span>

   <span class="c1">// Register bean as disposable.
</span><span class="c1"></span>   <span class="k">try</span> <span class="o">{</span>
      <span class="n">registerDisposableBeanIfNecessary</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">bean</span><span class="o">,</span> <span class="n">mbd</span><span class="o">);</span>
   <span class="o">}</span>
   <span class="k">catch</span> <span class="o">(</span><span class="n">BeanDefinitionValidationException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="n">BeanCreationException</span><span class="o">(</span>
            <span class="n">mbd</span><span class="o">.</span><span class="na">getResourceDescription</span><span class="o">(),</span> <span class="n">beanName</span><span class="o">,</span> <span class="s">&#34;Invalid destruction signature&#34;</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
   <span class="o">}</span>

   <span class="k">return</span> <span class="n">exposedObject</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>initializeBean方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">protected</span> <span class="n">Object</span> <span class="nf">initializeBean</span><span class="o">(</span><span class="n">String</span> <span class="n">beanName</span><span class="o">,</span> <span class="n">Object</span> <span class="n">bean</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="n">RootBeanDefinition</span> <span class="n">mbd</span><span class="o">)</span> <span class="o">{</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">getSecurityManager</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">AccessController</span><span class="o">.</span><span class="na">doPrivileged</span><span class="o">((</span><span class="n">PrivilegedAction</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;)</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
         <span class="n">invokeAwareMethods</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">bean</span><span class="o">);</span>
         <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
      <span class="o">},</span> <span class="n">getAccessControlContext</span><span class="o">());</span>
   <span class="o">}</span>
   <span class="k">else</span> <span class="o">{</span>
      <span class="n">invokeAwareMethods</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">bean</span><span class="o">);</span>
   <span class="o">}</span>

   <span class="n">Object</span> <span class="n">wrappedBean</span> <span class="o">=</span> <span class="n">bean</span><span class="o">;</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">mbd</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">mbd</span><span class="o">.</span><span class="na">isSynthetic</span><span class="o">())</span> <span class="o">{</span>
       <span class="c1">//调用前置处理
</span><span class="c1"></span>      <span class="n">wrappedBean</span> <span class="o">=</span> <span class="n">applyBeanPostProcessorsBeforeInitialization</span><span class="o">(</span><span class="n">wrappedBean</span><span class="o">,</span> <span class="n">beanName</span><span class="o">);</span>
   <span class="o">}</span>

   <span class="k">try</span> <span class="o">{</span>
       <span class="c1">//初始化
</span><span class="c1"></span>      <span class="n">invokeInitMethods</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">wrappedBean</span><span class="o">,</span> <span class="n">mbd</span><span class="o">);</span>
   <span class="o">}</span>
   <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="n">BeanCreationException</span><span class="o">(</span>
            <span class="o">(</span><span class="n">mbd</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">mbd</span><span class="o">.</span><span class="na">getResourceDescription</span><span class="o">()</span> <span class="o">:</span> <span class="kc">null</span><span class="o">),</span>
            <span class="n">beanName</span><span class="o">,</span> <span class="s">&#34;Invocation of init method failed&#34;</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
   <span class="o">}</span>
    <span class="c1">//调用后置处理，这里有机会生成代理
</span><span class="c1"></span>   <span class="k">if</span> <span class="o">(</span><span class="n">mbd</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">mbd</span><span class="o">.</span><span class="na">isSynthetic</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">wrappedBean</span> <span class="o">=</span> <span class="n">applyBeanPostProcessorsAfterInitialization</span><span class="o">(</span><span class="n">wrappedBean</span><span class="o">,</span> <span class="n">beanName</span><span class="o">);</span>
   <span class="o">}</span>

   <span class="k">return</span> <span class="n">wrappedBean</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">Object</span> <span class="nf">applyBeanPostProcessorsAfterInitialization</span><span class="o">(</span><span class="n">Object</span> <span class="n">existingBean</span><span class="o">,</span> <span class="n">String</span> <span class="n">beanName</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">BeansException</span> <span class="o">{</span>

   <span class="n">Object</span> <span class="n">result</span> <span class="o">=</span> <span class="n">existingBean</span><span class="o">;</span>
    <span class="c1">//获取beanPostProcessors
</span><span class="c1"></span>   <span class="k">for</span> <span class="o">(</span><span class="n">BeanPostProcessor</span> <span class="n">processor</span> <span class="o">:</span> <span class="n">getBeanPostProcessors</span><span class="o">())</span> <span class="o">{</span>
       <span class="c1">//调用对应的postProcessAfterInitialization方法，这里有机会产生代理对象
</span><span class="c1"></span>      <span class="n">Object</span> <span class="n">current</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="na">postProcessAfterInitialization</span><span class="o">(</span><span class="n">result</span><span class="o">,</span> <span class="n">beanName</span><span class="o">);</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">current</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="n">result</span> <span class="o">=</span> <span class="n">current</span><span class="o">;</span>
   <span class="o">}</span>
   <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>BeanPostProcessor下的postProcessAfterInitialization</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="k">default</span> <span class="n">Object</span> <span class="nf">postProcessAfterInitialization</span><span class="o">(</span><span class="n">Object</span> <span class="n">bean</span><span class="o">,</span> <span class="n">String</span> <span class="n">beanName</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">BeansException</span> <span class="o">{</span>
   <span class="k">return</span> <span class="n">bean</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>这里有很多实现类，可以发现有一些aop相关的实现类，如AbstractAutoProxyCreator，DefaultAdvisorAutoProxyCreator就继承自这个类，假设当前使用的就是DefaultAdvisorAutoProxyCreator，查看AbstractAutoProxyCreator的实现方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">Object</span> <span class="nf">postProcessAfterInitialization</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="n">Object</span> <span class="n">bean</span><span class="o">,</span> <span class="n">String</span> <span class="n">beanName</span><span class="o">)</span> <span class="o">{</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">bean</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">Object</span> <span class="n">cacheKey</span> <span class="o">=</span> <span class="n">getCacheKey</span><span class="o">(</span><span class="n">bean</span><span class="o">.</span><span class="na">getClass</span><span class="o">(),</span> <span class="n">beanName</span><span class="o">);</span>
      <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">earlyProxyReferences</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">cacheKey</span><span class="o">)</span> <span class="o">!=</span> <span class="n">bean</span><span class="o">)</span> <span class="o">{</span>
          <span class="c1">//是否有必要代理
</span><span class="c1"></span>         <span class="k">return</span> <span class="n">wrapIfNecessary</span><span class="o">(</span><span class="n">bean</span><span class="o">,</span> <span class="n">beanName</span><span class="o">,</span> <span class="n">cacheKey</span><span class="o">);</span>
      <span class="o">}</span>
   <span class="o">}</span>
   <span class="k">return</span> <span class="n">bean</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">protected</span> <span class="n">Object</span> <span class="nf">wrapIfNecessary</span><span class="o">(</span><span class="n">Object</span> <span class="n">bean</span><span class="o">,</span> <span class="n">String</span> <span class="n">beanName</span><span class="o">,</span> <span class="n">Object</span> <span class="n">cacheKey</span><span class="o">)</span> <span class="o">{</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">hasLength</span><span class="o">(</span><span class="n">beanName</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="o">.</span><span class="na">targetSourcedBeans</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">bean</span><span class="o">;</span>
   <span class="o">}</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">Boolean</span><span class="o">.</span><span class="na">FALSE</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">advisedBeans</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">cacheKey</span><span class="o">)))</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">bean</span><span class="o">;</span>
   <span class="o">}</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">isInfrastructureClass</span><span class="o">(</span><span class="n">bean</span><span class="o">.</span><span class="na">getClass</span><span class="o">())</span> <span class="o">||</span> <span class="n">shouldSkip</span><span class="o">(</span><span class="n">bean</span><span class="o">.</span><span class="na">getClass</span><span class="o">(),</span> <span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">advisedBeans</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">cacheKey</span><span class="o">,</span> <span class="n">Boolean</span><span class="o">.</span><span class="na">FALSE</span><span class="o">);</span>
      <span class="k">return</span> <span class="n">bean</span><span class="o">;</span>
   <span class="o">}</span>

   <span class="c1">// Create proxy if we have advice.
</span><span class="c1"></span>    <span class="c1">//获取到合适的advices和advisors，如果没有会返回DO_NOT_RPOXY，一个空的Object[]
</span><span class="c1"></span>   <span class="n">Object</span><span class="o">[]</span> <span class="n">specificInterceptors</span> <span class="o">=</span> <span class="n">getAdvicesAndAdvisorsForBean</span><span class="o">(</span><span class="n">bean</span><span class="o">.</span><span class="na">getClass</span><span class="o">(),</span> <span class="n">beanName</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">specificInterceptors</span> <span class="o">!=</span> <span class="n">DO_NOT_PROXY</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">advisedBeans</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">cacheKey</span><span class="o">,</span> <span class="n">Boolean</span><span class="o">.</span><span class="na">TRUE</span><span class="o">);</span>
       <span class="c1">//创建代理对象
</span><span class="c1"></span>      <span class="n">Object</span> <span class="n">proxy</span> <span class="o">=</span> <span class="n">createProxy</span><span class="o">(</span>
            <span class="n">bean</span><span class="o">.</span><span class="na">getClass</span><span class="o">(),</span> <span class="n">beanName</span><span class="o">,</span> <span class="n">specificInterceptors</span><span class="o">,</span> <span class="k">new</span> <span class="n">SingletonTargetSource</span><span class="o">(</span><span class="n">bean</span><span class="o">));</span>
      <span class="k">this</span><span class="o">.</span><span class="na">proxyTypes</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">cacheKey</span><span class="o">,</span> <span class="n">proxy</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
      <span class="k">return</span> <span class="n">proxy</span><span class="o">;</span>
   <span class="o">}</span>

   <span class="k">this</span><span class="o">.</span><span class="na">advisedBeans</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">cacheKey</span><span class="o">,</span> <span class="n">Boolean</span><span class="o">.</span><span class="na">FALSE</span><span class="o">);</span>
   <span class="k">return</span> <span class="n">bean</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">protected</span> <span class="kd">abstract</span> <span class="n">Object</span><span class="o">[]</span> <span class="nf">getAdvicesAndAdvisorsForBean</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">beanClass</span><span class="o">,</span> <span class="n">String</span> <span class="n">beanName</span><span class="o">,</span>
      <span class="nd">@Nullable</span> <span class="n">TargetSource</span> <span class="n">customTargetSource</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">BeansException</span><span class="o">;</span>
</code></pre></td></tr></table>
</div>
</div><p>这里对应的实现类是AbstractAdvisorAutoProxyCreator，DefaultAdvisorAutoProxyCreator是它的子类</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">protected</span> <span class="n">Object</span><span class="o">[]</span> <span class="nf">getAdvicesAndAdvisorsForBean</span><span class="o">(</span>
      <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">beanClass</span><span class="o">,</span> <span class="n">String</span> <span class="n">beanName</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="n">TargetSource</span> <span class="n">targetSource</span><span class="o">)</span> <span class="o">{</span>

    <span class="c1">//获取符合条件的advisors
</span><span class="c1"></span>   <span class="n">List</span><span class="o">&lt;</span><span class="n">Advisor</span><span class="o">&gt;</span> <span class="n">advisors</span> <span class="o">=</span> <span class="n">findEligibleAdvisors</span><span class="o">(</span><span class="n">beanClass</span><span class="o">,</span> <span class="n">beanName</span><span class="o">);</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">advisors</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">DO_NOT_PROXY</span><span class="o">;</span>
   <span class="o">}</span>
   <span class="k">return</span> <span class="n">advisors</span><span class="o">.</span><span class="na">toArray</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">protected</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Advisor</span><span class="o">&gt;</span> <span class="nf">findEligibleAdvisors</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">beanClass</span><span class="o">,</span> <span class="n">String</span> <span class="n">beanName</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//获取候选的advisors，获取到了Advisor的bean
</span><span class="c1"></span>   <span class="n">List</span><span class="o">&lt;</span><span class="n">Advisor</span><span class="o">&gt;</span> <span class="n">candidateAdvisors</span> <span class="o">=</span> <span class="n">findCandidateAdvisors</span><span class="o">();</span>
    <span class="c1">//找到符合条件的advisor，对每个候选的advisor进行匹配
</span><span class="c1"></span>   <span class="n">List</span><span class="o">&lt;</span><span class="n">Advisor</span><span class="o">&gt;</span> <span class="n">eligibleAdvisors</span> <span class="o">=</span> <span class="n">findAdvisorsThatCanApply</span><span class="o">(</span><span class="n">candidateAdvisors</span><span class="o">,</span> <span class="n">beanClass</span><span class="o">,</span> <span class="n">beanName</span><span class="o">);</span>
    <span class="c1">//拓展advisors，当使用AspectJ才会有用，在list的开始处添加了ExposeInvocationInterceptor
</span><span class="c1"></span>   <span class="n">extendAdvisors</span><span class="o">(</span><span class="n">eligibleAdvisors</span><span class="o">);</span>
   <span class="k">if</span> <span class="o">(!</span><span class="n">eligibleAdvisors</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
       <span class="c1">//对advisors进行排序
</span><span class="c1"></span>      <span class="n">eligibleAdvisors</span> <span class="o">=</span> <span class="n">sortAdvisors</span><span class="o">(</span><span class="n">eligibleAdvisors</span><span class="o">);</span>
   <span class="o">}</span>
   <span class="k">return</span> <span class="n">eligibleAdvisors</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>回到之前的wrapIfNecessary方法，查看其中的createProxy方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">protected</span> <span class="n">Object</span> <span class="nf">createProxy</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">beanClass</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="n">String</span> <span class="n">beanName</span><span class="o">,</span>
      <span class="nd">@Nullable</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">specificInterceptors</span><span class="o">,</span> <span class="n">TargetSource</span> <span class="n">targetSource</span><span class="o">)</span> <span class="o">{</span>

   <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">beanFactory</span> <span class="k">instanceof</span> <span class="n">ConfigurableListableBeanFactory</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">AutoProxyUtils</span><span class="o">.</span><span class="na">exposeTargetClass</span><span class="o">((</span><span class="n">ConfigurableListableBeanFactory</span><span class="o">)</span> <span class="k">this</span><span class="o">.</span><span class="na">beanFactory</span><span class="o">,</span> <span class="n">beanName</span><span class="o">,</span> <span class="n">beanClass</span><span class="o">);</span>
   <span class="o">}</span>

    <span class="c1">//创建proxyFactory
</span><span class="c1"></span>   <span class="n">ProxyFactory</span> <span class="n">proxyFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ProxyFactory</span><span class="o">();</span>
    <span class="c1">//从当前config对象复制配置到proxyFactory中
</span><span class="c1"></span>   <span class="n">proxyFactory</span><span class="o">.</span><span class="na">copyFrom</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>

    <span class="c1">//对应配置proxy-target-class，默认为false
</span><span class="c1"></span>   <span class="k">if</span> <span class="o">(!</span><span class="n">proxyFactory</span><span class="o">.</span><span class="na">isProxyTargetClass</span><span class="o">())</span> <span class="o">{</span>
       <span class="c1">//是否应该代理目标类而不是特定的接口
</span><span class="c1"></span>      <span class="k">if</span> <span class="o">(</span><span class="n">shouldProxyTargetClass</span><span class="o">(</span><span class="n">beanClass</span><span class="o">,</span> <span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
         <span class="n">proxyFactory</span><span class="o">.</span><span class="na">setProxyTargetClass</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">else</span> <span class="o">{</span>
          <span class="c1">//检查该类的接口，如果没有合理的也会设置proxyTargetClass为true
</span><span class="c1"></span>         <span class="n">evaluateProxyInterfaces</span><span class="o">(</span><span class="n">beanClass</span><span class="o">,</span> <span class="n">proxyFactory</span><span class="o">);</span>
      <span class="o">}</span>
   <span class="o">}</span>

   <span class="n">Advisor</span><span class="o">[]</span> <span class="n">advisors</span> <span class="o">=</span> <span class="n">buildAdvisors</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">specificInterceptors</span><span class="o">);</span>
   <span class="n">proxyFactory</span><span class="o">.</span><span class="na">addAdvisors</span><span class="o">(</span><span class="n">advisors</span><span class="o">);</span>
   <span class="n">proxyFactory</span><span class="o">.</span><span class="na">setTargetSource</span><span class="o">(</span><span class="n">targetSource</span><span class="o">);</span>
    <span class="c1">//默认空实现，可以选择让子类实现
</span><span class="c1"></span>   <span class="n">customizeProxyFactory</span><span class="o">(</span><span class="n">proxyFactory</span><span class="o">);</span>

   <span class="n">proxyFactory</span><span class="o">.</span><span class="na">setFrozen</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">freezeProxy</span><span class="o">);</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">advisorsPreFiltered</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">proxyFactory</span><span class="o">.</span><span class="na">setPreFiltered</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
   <span class="o">}</span>

   <span class="k">return</span> <span class="n">proxyFactory</span><span class="o">.</span><span class="na">getProxy</span><span class="o">(</span><span class="n">getProxyClassLoader</span><span class="o">());</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">Object</span> <span class="nf">getProxy</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="n">ClassLoader</span> <span class="n">classLoader</span><span class="o">)</span> <span class="o">{</span>
   <span class="k">return</span> <span class="n">createAopProxy</span><span class="o">().</span><span class="na">getProxy</span><span class="o">(</span><span class="n">classLoader</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>先查看createAopProxy</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">protected</span> <span class="kd">final</span> <span class="kd">synchronized</span> <span class="n">AopProxy</span> <span class="nf">createAopProxy</span><span class="o">()</span> <span class="o">{</span>
   <span class="k">if</span> <span class="o">(!</span><span class="k">this</span><span class="o">.</span><span class="na">active</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">activate</span><span class="o">();</span>
   <span class="o">}</span>
    <span class="c1">//根据情况判断是用jdk动态代理还是cglib代理
</span><span class="c1"></span>   <span class="k">return</span> <span class="n">getAopProxyFactory</span><span class="o">().</span><span class="na">createAopProxy</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">AopProxy</span> <span class="nf">createAopProxy</span><span class="o">(</span><span class="n">AdvisedSupport</span> <span class="n">config</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">AopConfigException</span><span class="o">;</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">AopProxy</span> <span class="nf">createAopProxy</span><span class="o">(</span><span class="n">AdvisedSupport</span> <span class="n">config</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">AopConfigException</span> <span class="o">{</span>
    <span class="c1">//分别为 是否进行优化，proxyTargetClass的boolean值，没有实现接口或只实现了SpringProxy接口
</span><span class="c1"></span>   <span class="k">if</span> <span class="o">(</span><span class="n">config</span><span class="o">.</span><span class="na">isOptimize</span><span class="o">()</span> <span class="o">||</span> <span class="n">config</span><span class="o">.</span><span class="na">isProxyTargetClass</span><span class="o">()</span> <span class="o">||</span> <span class="n">hasNoUserSuppliedProxyInterfaces</span><span class="o">(</span><span class="n">config</span><span class="o">))</span> <span class="o">{</span>
      <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">targetClass</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="na">getTargetClass</span><span class="o">();</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">targetClass</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">throw</span> <span class="k">new</span> <span class="n">AopConfigException</span><span class="o">(</span><span class="s">&#34;TargetSource cannot determine target class: &#34;</span> <span class="o">+</span>
               <span class="s">&#34;Either an interface or a target is required for proxy creation.&#34;</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">targetClass</span><span class="o">.</span><span class="na">isInterface</span><span class="o">()</span> <span class="o">||</span> <span class="n">Proxy</span><span class="o">.</span><span class="na">isProxyClass</span><span class="o">(</span><span class="n">targetClass</span><span class="o">))</span> <span class="o">{</span>
         <span class="k">return</span> <span class="k">new</span> <span class="n">JdkDynamicAopProxy</span><span class="o">(</span><span class="n">config</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="k">new</span> <span class="n">ObjenesisCglibAopProxy</span><span class="o">(</span><span class="n">config</span><span class="o">);</span>
   <span class="o">}</span>
   <span class="k">else</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="n">JdkDynamicAopProxy</span><span class="o">(</span><span class="n">config</span><span class="o">);</span>
   <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>回到ProxyFactory的getProxy方法，再查看其中的getProxy方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">Object</span> <span class="nf">getProxy</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="n">ClassLoader</span> <span class="n">classLoader</span><span class="o">)</span> <span class="o">{</span>
   <span class="k">return</span> <span class="n">createAopProxy</span><span class="o">().</span><span class="na">getProxy</span><span class="o">(</span><span class="n">classLoader</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">Object</span> <span class="nf">getProxy</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="n">ClassLoader</span> <span class="n">classLoader</span><span class="o">);</span>
</code></pre></td></tr></table>
</div>
</div><p>这里有2种实现，取决于之前获得到的AopProxy是cglib的方式还是jdk动态代理的方式</p>
<h3 id="jdkdynamicaopproxy">JdkDynamicAopProxy</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">Object</span> <span class="nf">getProxy</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="n">ClassLoader</span> <span class="n">classLoader</span><span class="o">)</span> <span class="o">{</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isTraceEnabled</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">logger</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">&#34;Creating JDK dynamic proxy: &#34;</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">advised</span><span class="o">.</span><span class="na">getTargetSource</span><span class="o">());</span>
   <span class="o">}</span>
   <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">proxiedInterfaces</span> <span class="o">=</span> <span class="n">AopProxyUtils</span><span class="o">.</span><span class="na">completeProxiedInterfaces</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">advised</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
   <span class="n">findDefinedEqualsAndHashCodeMethods</span><span class="o">(</span><span class="n">proxiedInterfaces</span><span class="o">);</span>
    <span class="c1">//返回代理对象
</span><span class="c1"></span>   <span class="k">return</span> <span class="n">Proxy</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span><span class="n">classLoader</span><span class="o">,</span> <span class="n">proxiedInterfaces</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>JdkDynamicAopProxy也基础了InvocationHandler接口，查看其实现的invoke方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">Object</span> <span class="nf">invoke</span><span class="o">(</span><span class="n">Object</span> <span class="n">proxy</span><span class="o">,</span> <span class="n">Method</span> <span class="n">method</span><span class="o">,</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
   <span class="n">Object</span> <span class="n">oldProxy</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
   <span class="kt">boolean</span> <span class="n">setProxyContext</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>

   <span class="n">TargetSource</span> <span class="n">targetSource</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">advised</span><span class="o">.</span><span class="na">targetSource</span><span class="o">;</span>
   <span class="n">Object</span> <span class="n">target</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

   <span class="k">try</span> <span class="o">{</span>
       <span class="c1">//对equals方法
</span><span class="c1"></span>      <span class="k">if</span> <span class="o">(!</span><span class="k">this</span><span class="o">.</span><span class="na">equalsDefined</span> <span class="o">&amp;&amp;</span> <span class="n">AopUtils</span><span class="o">.</span><span class="na">isEqualsMethod</span><span class="o">(</span><span class="n">method</span><span class="o">))</span> <span class="o">{</span>
         <span class="c1">// The target does not implement the equals(Object) method itself.
</span><span class="c1"></span>         <span class="k">return</span> <span class="n">equals</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="n">0</span><span class="o">]);</span>
      <span class="o">}</span>
       <span class="c1">//对hashCode方法
</span><span class="c1"></span>      <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="k">this</span><span class="o">.</span><span class="na">hashCodeDefined</span> <span class="o">&amp;&amp;</span> <span class="n">AopUtils</span><span class="o">.</span><span class="na">isHashCodeMethod</span><span class="o">(</span><span class="n">method</span><span class="o">))</span> <span class="o">{</span>
         <span class="c1">// The target does not implement the hashCode() method itself.
</span><span class="c1"></span>         <span class="k">return</span> <span class="n">hashCode</span><span class="o">();</span>
      <span class="o">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">getDeclaringClass</span><span class="o">()</span> <span class="o">==</span> <span class="n">DecoratingProxy</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
         <span class="c1">// There is only getDecoratedClass() declared -&gt; dispatch to proxy config.
</span><span class="c1"></span>         <span class="k">return</span> <span class="n">AopProxyUtils</span><span class="o">.</span><span class="na">ultimateTargetClass</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">advised</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="k">this</span><span class="o">.</span><span class="na">advised</span><span class="o">.</span><span class="na">opaque</span> <span class="o">&amp;&amp;</span> <span class="n">method</span><span class="o">.</span><span class="na">getDeclaringClass</span><span class="o">().</span><span class="na">isInterface</span><span class="o">()</span> <span class="o">&amp;&amp;</span>
            <span class="n">method</span><span class="o">.</span><span class="na">getDeclaringClass</span><span class="o">().</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">Advised</span><span class="o">.</span><span class="na">class</span><span class="o">))</span> <span class="o">{</span>
         <span class="c1">// Service invocations on ProxyConfig with the proxy config...
</span><span class="c1"></span>          <span class="c1">//使用反射执行方法
</span><span class="c1"></span>         <span class="k">return</span> <span class="n">AopUtils</span><span class="o">.</span><span class="na">invokeJoinpointUsingReflection</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">advised</span><span class="o">,</span> <span class="n">method</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="n">Object</span> <span class="n">retVal</span><span class="o">;</span>

       <span class="c1">//是否暴露代理
</span><span class="c1"></span>      <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">advised</span><span class="o">.</span><span class="na">exposeProxy</span><span class="o">)</span> <span class="o">{</span>
         <span class="c1">// Make invocation available if necessary.
</span><span class="c1"></span>         <span class="n">oldProxy</span> <span class="o">=</span> <span class="n">AopContext</span><span class="o">.</span><span class="na">setCurrentProxy</span><span class="o">(</span><span class="n">proxy</span><span class="o">);</span>
         <span class="n">setProxyContext</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="c1">// Get as late as possible to minimize the time we &#34;own&#34; the target,
</span><span class="c1"></span>      <span class="c1">// in case it comes from a pool.
</span><span class="c1"></span>      <span class="n">target</span> <span class="o">=</span> <span class="n">targetSource</span><span class="o">.</span><span class="na">getTarget</span><span class="o">();</span>
      <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">targetClass</span> <span class="o">=</span> <span class="o">(</span><span class="n">target</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">target</span><span class="o">.</span><span class="na">getClass</span><span class="o">()</span> <span class="o">:</span> <span class="kc">null</span><span class="o">);</span>

      <span class="c1">// Get the interception chain for this method.
</span><span class="c1"></span>       <span class="c1">//获取该方法的拦截链
</span><span class="c1"></span>      <span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">chain</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">advised</span><span class="o">.</span><span class="na">getInterceptorsAndDynamicInterceptionAdvice</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="n">targetClass</span><span class="o">);</span>

      <span class="c1">// Check whether we have any advice. If we don&#39;t, we can fallback on direct
</span><span class="c1"></span>      <span class="c1">// reflective invocation of the target, and avoid creating a MethodInvocation.
</span><span class="c1"></span>       <span class="c1">//如果没有拦截链，直接调用方法
</span><span class="c1"></span>      <span class="k">if</span> <span class="o">(</span><span class="n">chain</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
         <span class="c1">// We can skip creating a MethodInvocation: just invoke the target directly
</span><span class="c1"></span>         <span class="c1">// Note that the final invoker must be an InvokerInterceptor so we know it does
</span><span class="c1"></span>         <span class="c1">// nothing but a reflective operation on the target, and no hot swapping or fancy proxying.
</span><span class="c1"></span>         <span class="n">Object</span><span class="o">[]</span> <span class="n">argsToUse</span> <span class="o">=</span> <span class="n">AopProxyUtils</span><span class="o">.</span><span class="na">adaptArgumentsIfNecessary</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
          <span class="c1">//使用反射直接执行方法
</span><span class="c1"></span>         <span class="n">retVal</span> <span class="o">=</span> <span class="n">AopUtils</span><span class="o">.</span><span class="na">invokeJoinpointUsingReflection</span><span class="o">(</span><span class="n">target</span><span class="o">,</span> <span class="n">method</span><span class="o">,</span> <span class="n">argsToUse</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">else</span> <span class="o">{</span>
         <span class="c1">// We need to create a method invocation...
</span><span class="c1"></span>          <span class="c1">//创建一个方法调用对象
</span><span class="c1"></span>         <span class="n">MethodInvocation</span> <span class="n">invocation</span> <span class="o">=</span>
               <span class="k">new</span> <span class="n">ReflectiveMethodInvocation</span><span class="o">(</span><span class="n">proxy</span><span class="o">,</span> <span class="n">target</span><span class="o">,</span> <span class="n">method</span><span class="o">,</span> <span class="n">args</span><span class="o">,</span> <span class="n">targetClass</span><span class="o">,</span> <span class="n">chain</span><span class="o">);</span>
         <span class="c1">// Proceed to the joinpoint through the interceptor chain.
</span><span class="c1"></span>          <span class="c1">//调用各个proceed
</span><span class="c1"></span>         <span class="n">retVal</span> <span class="o">=</span> <span class="n">invocation</span><span class="o">.</span><span class="na">proceed</span><span class="o">();</span>
      <span class="o">}</span>

      <span class="c1">// Massage return value if necessary.
</span><span class="c1"></span>      <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">returnType</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">getReturnType</span><span class="o">();</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">retVal</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">retVal</span> <span class="o">==</span> <span class="n">target</span> <span class="o">&amp;&amp;</span>
            <span class="n">returnType</span> <span class="o">!=</span> <span class="n">Object</span><span class="o">.</span><span class="na">class</span> <span class="o">&amp;&amp;</span> <span class="n">returnType</span><span class="o">.</span><span class="na">isInstance</span><span class="o">(</span><span class="n">proxy</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
            <span class="o">!</span><span class="n">RawTargetAccess</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">getDeclaringClass</span><span class="o">()))</span> <span class="o">{</span>
         <span class="c1">// Special case: it returned &#34;this&#34; and the return type of the method
</span><span class="c1"></span>         <span class="c1">// is type-compatible. Note that we can&#39;t help if the target sets
</span><span class="c1"></span>         <span class="c1">// a reference to itself in another returned object.
</span><span class="c1"></span>         <span class="n">retVal</span> <span class="o">=</span> <span class="n">proxy</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">retVal</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">returnType</span> <span class="o">!=</span> <span class="n">Void</span><span class="o">.</span><span class="na">TYPE</span> <span class="o">&amp;&amp;</span> <span class="n">returnType</span><span class="o">.</span><span class="na">isPrimitive</span><span class="o">())</span> <span class="o">{</span>
         <span class="k">throw</span> <span class="k">new</span> <span class="n">AopInvocationException</span><span class="o">(</span>
               <span class="s">&#34;Null return value from advice does not match primitive return type for: &#34;</span> <span class="o">+</span> <span class="n">method</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="n">retVal</span><span class="o">;</span>
   <span class="o">}</span>
   <span class="k">finally</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">target</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">targetSource</span><span class="o">.</span><span class="na">isStatic</span><span class="o">())</span> <span class="o">{</span>
         <span class="c1">// Must have come from TargetSource.
</span><span class="c1"></span>         <span class="n">targetSource</span><span class="o">.</span><span class="na">releaseTarget</span><span class="o">(</span><span class="n">target</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">setProxyContext</span><span class="o">)</span> <span class="o">{</span>
         <span class="c1">// Restore old proxy.
</span><span class="c1"></span>         <span class="n">AopContext</span><span class="o">.</span><span class="na">setCurrentProxy</span><span class="o">(</span><span class="n">oldProxy</span><span class="o">);</span>
      <span class="o">}</span>
   <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="cglibaopproxy">CglibAopProxy</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">Object</span> <span class="nf">getProxy</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="n">ClassLoader</span> <span class="n">classLoader</span><span class="o">)</span> <span class="o">{</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isTraceEnabled</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">logger</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">&#34;Creating CGLIB proxy: &#34;</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">advised</span><span class="o">.</span><span class="na">getTargetSource</span><span class="o">());</span>
   <span class="o">}</span>

   <span class="k">try</span> <span class="o">{</span>
      <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">rootClass</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">advised</span><span class="o">.</span><span class="na">getTargetClass</span><span class="o">();</span>
      <span class="n">Assert</span><span class="o">.</span><span class="na">state</span><span class="o">(</span><span class="n">rootClass</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">,</span> <span class="s">&#34;Target class must be available for creating a CGLIB proxy&#34;</span><span class="o">);</span>

      <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">proxySuperClass</span> <span class="o">=</span> <span class="n">rootClass</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">rootClass</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="n">ClassUtils</span><span class="o">.</span><span class="na">CGLIB_CLASS_SEPARATOR</span><span class="o">))</span> <span class="o">{</span>
         <span class="n">proxySuperClass</span> <span class="o">=</span> <span class="n">rootClass</span><span class="o">.</span><span class="na">getSuperclass</span><span class="o">();</span>
         <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">additionalInterfaces</span> <span class="o">=</span> <span class="n">rootClass</span><span class="o">.</span><span class="na">getInterfaces</span><span class="o">();</span>
         <span class="k">for</span> <span class="o">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">additionalInterface</span> <span class="o">:</span> <span class="n">additionalInterfaces</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">advised</span><span class="o">.</span><span class="na">addInterface</span><span class="o">(</span><span class="n">additionalInterface</span><span class="o">);</span>
         <span class="o">}</span>
      <span class="o">}</span>

      <span class="c1">// Validate the class, writing log messages as necessary.
</span><span class="c1"></span>      <span class="n">validateClassIfNecessary</span><span class="o">(</span><span class="n">proxySuperClass</span><span class="o">,</span> <span class="n">classLoader</span><span class="o">);</span>

      <span class="c1">// Configure CGLIB Enhancer...
</span><span class="c1"></span>       <span class="c1">//创建enhancer
</span><span class="c1"></span>      <span class="n">Enhancer</span> <span class="n">enhancer</span> <span class="o">=</span> <span class="n">createEnhancer</span><span class="o">();</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">classLoader</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
         <span class="n">enhancer</span><span class="o">.</span><span class="na">setClassLoader</span><span class="o">(</span><span class="n">classLoader</span><span class="o">);</span>
         <span class="k">if</span> <span class="o">(</span><span class="n">classLoader</span> <span class="k">instanceof</span> <span class="n">SmartClassLoader</span> <span class="o">&amp;&amp;</span>
               <span class="o">((</span><span class="n">SmartClassLoader</span><span class="o">)</span> <span class="n">classLoader</span><span class="o">).</span><span class="na">isClassReloadable</span><span class="o">(</span><span class="n">proxySuperClass</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">enhancer</span><span class="o">.</span><span class="na">setUseCache</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
         <span class="o">}</span>
      <span class="o">}</span>
      <span class="n">enhancer</span><span class="o">.</span><span class="na">setSuperclass</span><span class="o">(</span><span class="n">proxySuperClass</span><span class="o">);</span>
      <span class="n">enhancer</span><span class="o">.</span><span class="na">setInterfaces</span><span class="o">(</span><span class="n">AopProxyUtils</span><span class="o">.</span><span class="na">completeProxiedInterfaces</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">advised</span><span class="o">));</span>
      <span class="n">enhancer</span><span class="o">.</span><span class="na">setNamingPolicy</span><span class="o">(</span><span class="n">SpringNamingPolicy</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">);</span>
      <span class="n">enhancer</span><span class="o">.</span><span class="na">setStrategy</span><span class="o">(</span><span class="k">new</span> <span class="n">ClassLoaderAwareGeneratorStrategy</span><span class="o">(</span><span class="n">classLoader</span><span class="o">));</span>

      <span class="n">Callback</span><span class="o">[]</span> <span class="n">callbacks</span> <span class="o">=</span> <span class="n">getCallbacks</span><span class="o">(</span><span class="n">rootClass</span><span class="o">);</span>
      <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">types</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Class</span><span class="o">&lt;?&gt;[</span><span class="n">callbacks</span><span class="o">.</span><span class="na">length</span><span class="o">];</span>
      <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">types</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">x</span><span class="o">++)</span> <span class="o">{</span>
         <span class="n">types</span><span class="o">[</span><span class="n">x</span><span class="o">]</span> <span class="o">=</span> <span class="n">callbacks</span><span class="o">[</span><span class="n">x</span><span class="o">].</span><span class="na">getClass</span><span class="o">();</span>
      <span class="o">}</span>
      <span class="c1">// fixedInterceptorMap only populated at this point, after getCallbacks call above
</span><span class="c1"></span>      <span class="n">enhancer</span><span class="o">.</span><span class="na">setCallbackFilter</span><span class="o">(</span><span class="k">new</span> <span class="n">ProxyCallbackFilter</span><span class="o">(</span>
            <span class="k">this</span><span class="o">.</span><span class="na">advised</span><span class="o">.</span><span class="na">getConfigurationOnlyCopy</span><span class="o">(),</span> <span class="k">this</span><span class="o">.</span><span class="na">fixedInterceptorMap</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">fixedInterceptorOffset</span><span class="o">));</span>
      <span class="n">enhancer</span><span class="o">.</span><span class="na">setCallbackTypes</span><span class="o">(</span><span class="n">types</span><span class="o">);</span>

      <span class="c1">// Generate the proxy class and create a proxy instance.
</span><span class="c1"></span>       <span class="c1">//创建代理类和代理对象
</span><span class="c1"></span>      <span class="k">return</span> <span class="n">createProxyClassAndInstance</span><span class="o">(</span><span class="n">enhancer</span><span class="o">,</span> <span class="n">callbacks</span><span class="o">);</span>
   <span class="o">}</span>
   <span class="k">catch</span> <span class="o">(</span><span class="n">CodeGenerationException</span> <span class="o">|</span> <span class="n">IllegalArgumentException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="n">AopConfigException</span><span class="o">(</span><span class="s">&#34;Could not generate CGLIB subclass of &#34;</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">advised</span><span class="o">.</span><span class="na">getTargetClass</span><span class="o">()</span> <span class="o">+</span>
            <span class="s">&#34;: Common causes of this problem include using a final class or a non-visible class&#34;</span><span class="o">,</span>
            <span class="n">ex</span><span class="o">);</span>
   <span class="o">}</span>
   <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// TargetSource.getTarget() failed
</span><span class="c1"></span>      <span class="k">throw</span> <span class="k">new</span> <span class="n">AopConfigException</span><span class="o">(</span><span class="s">&#34;Unexpected AOP exception&#34;</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
   <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div>
    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">sww</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2020-08-28
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/spring/">spring</a>
          <a href="/tags/spring-aop/">spring-aop</a>
          <a href="/tags/java/">java</a>
          </div>
      <nav class="post-nav">
        
        <a class="next" href="/post/spring-ioc/">
            <span class="next-text nav-default">Spring Ioc源码阅读</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:your@email.com" class="iconfont icon-email" title="email"></a>
      <a href="http://github.com/shuwenwei" class="iconfont icon-github" title="github"></a>
  <a href="https://shuwenwei.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> 本站总访问量 <span id="busuanzi_value_site_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次 </span>
      <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> 本站总访客数 <span id="busuanzi_value_site_uv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 人 </span>
  </div>

  <span class="copyright-year">
    &copy; 
    2020
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">sww</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
<script src="https://cdn.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/autoload.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/timeago.js@3.0.2/dist/timeago.min.js" integrity="sha256-jwCP0NAdCBloaIWTWHmW4i3snUNMHUNO+jr9rYd2iOI=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/timeago.js@3.0.2/dist/timeago.locales.min.js" integrity="sha256-ZwofwC1Lf/faQCzN7nZtfijVV6hSwxjQMwXL4gn9qU8=" crossorigin="anonymous"></script>
  <script><!-- NOTE: timeago.js uses the language code format like "zh_CN" (underscore and case sensitive) -->
    var languageCode = "zh-cn".replace(/-/g, '_').replace(/_(.*)/, function ($0, $1) {return $0.replace($1, $1.toUpperCase());});
    timeago().render(document.querySelectorAll('.timeago'), languageCode);
    timeago.cancel();  
  </script>



<script type="text/javascript" src="/js/main.min.d7b7ada643c9c1a983026e177f141f7363b4640d619caf01d8831a6718cd44ea.js"></script>








</body>
</html>
